{% load static %}

<!-- 금액설정 모달 -->
<div id="moneystepinfo-modal"
     x-data="{ open: {% if is_show_money_info %} true {% else %} false {% endif %}, initialMoney: '' }"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-[99999] flex items-center justify-center bg-black bg-opacity-50"
     role="dialog"
     aria-modal="true"
     aria-labelledby="moneystepinfo-title"
     @keydown.escape.window="open = false"
     @modal-open.window="
        console.log('moneystepinfo-modal: modal-open 이벤트 수신', $el.id, $event.detail.modalId);
        if ($event.detail && $event.detail.modalId === $el.id) { 
            open = true;
            console.log('moneystepinfo-modal: open 상태 true로 변경됨');
        }
     "
     @modal-close.window="
        console.log('moneystepinfo-modal: modal-close 이벤트 수신', $el.id, $event.detail.modalId);
        if ($event.detail && $event.detail.modalId === $el.id) { 
            open = false;
            console.log('moneystepinfo-modal: open 상태 false로 변경됨');
        }
     ">

  <div x-show="open"
       x-transition:enter="ease-out duration-300"
       x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
       x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
       x-transition:leave="ease-in duration-200"
       x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
       x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
       class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg w-[90%] max-w-md p-6 text-gray-800 dark:text-gray-100">
    
    <!-- 헤더 -->
    <div class="flex items-center justify-between border-b pb-3 dark:border-gray-600">
      <h3 id="moneystepinfo-title" class="text-lg font-semibold leading-6">게임설정</h3>
      <button type="button" @click="open = false"
              class="rounded-md p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:hover:bg-gray-700">
        <span class="sr-only">닫기</span>
        <i class="ti ti-x text-xl"></i>
      </button>
    </div>

    <!-- 바디 -->
    <div class="mt-4">
      <form id="moneystepinfo-form">
        <div class="mb-4 hidden"> 
          <label for="game-count" class="mb-1 block text-sm font-medium">게임입력횟수 (10회이상):</label>
          <input type="text" id="game-count" inputmode="numeric" value="0"
                 class="block w-full rounded-md border bg-white px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100"
                 placeholder="예: 10">
        </div>
        <div class="mb-4">
          <label for="money" class="mb-1 block text-sm font-medium">시작금액:</label>
          <input type="text" id="money" x-model="initialMoney" inputmode="numeric"
                 class="block w-full rounded-md border bg-white px-3 py-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100"
                 placeholder="예: 10000">
        </div>
      </form>
    </div>

    <!-- 푸터 -->
    <div class="mt-5 flex justify-end border-t pt-4 dark:border-gray-600">
      <button type="button"
              @click="gotomoneyAndCloseModal('moneystepinfo-modal'); open = false;"
              class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
        확인
      </button>
    </div>
  </div>
</div>


<!-- 환경설정 모달 -->
<div id="setting-box-modal" 
    x-data="{ open: false,
              gameSettingEnabled: false,
              moneyInfoVisible: false,
              soundSettingEnable: false,
              showConsoleEnable: true,
              virtualBettingEnabled: true,
              
              // saveSettings 함수를 x-data 내부에 직접 정의합니다.
              saveSettings() {
                console.log('setting-box-modal: saveSettings() 호출됨');
                const settings = {
                    gameSettingEnabled: this.gameSettingEnabled,
                    moneyInfoVisible: this.moneyInfoVisible,
                    soundSettingEnable: this.soundSettingEnable,
                    showConsoleEnable: this.showConsoleEnable,
                    virtualBettingEnabled: this.virtualBettingEnabled
                    // selectedLogic은 이 모달에서 직접 변경되지 않으므로,
                    // loadSavedSettings()에서 가져온 값을 유지합니다.
                    // (또는 이 모달에 로직 선택 기능이 있다면 this.selectedLogic 추가)
                };
                // 기존 로컬 스토리지에 저장된 selectedLogic을 유지
                const existingSettings = loadSavedSettings();
                settings.selectedLogic = existingSettings.selectedLogic;

                localStorage.setItem(GAMEENV_KEY, JSON.stringify(settings));
                console.log('setting-box-modal: 모든 설정이 로컬 스토리지에 저장됨:', settings);

                // 설정 저장 후 UI 업데이트 적용 (외부 함수 호출)
                applyVisibility('money-step-wrapper', settings.moneyInfoVisible);
                applyVisibility('interactive-area', settings.showConsoleEnable);
                // updateLogicButtonsUI(settings.selectedLogic); // 로직 버튼은 개별 클릭 시 업데이트되므로 여기서 불필요
              }
            }"
     x-show="open"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     @modal-open.window="console.log('setting-box-modal: modal-open 이벤트 수신', $el.id, $event.detail.modalId); if($event.detail.modalId==='setting-box-modal'){ open=true; console.log('setting-box-modal: open 상태 true로 변경됨'); }"
     @modal-close.window="console.log('setting-box-modal: modal-close 이벤트 수신', $el.id, $event.detail.modalId); if($event.detail.modalId==='setting-box-modal'){ open=false; console.log('setting-box-modal: open 상태 false로 변경됨'); }"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]"
     style="display:none">
    
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg w-96 text-gray-800 dark:text-gray-100"
         @click.stop=""
         x-init="$watch('open', value => {
            if (value) {
                const settings = loadSavedSettings();
                gameSettingEnabled = settings.gameSettingEnabled;
                moneyInfoVisible = settings.moneyInfoVisible;
                soundSettingEnable = settings.soundSettingEnable;
                showConsoleEnable = settings.showConsoleEnable;
                virtualBettingEnabled = settings.virtualBettingEnabled;
            }
        });">
        <h2 class="text-xl font-bold mb-4">환경설정</h2>
        <div class="space-y-3">
            <form id="setting-box-form" class="space-y-4">
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label for="gamesetting-toggle"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300">게임셋팅하기</label>
                        <button type="button" role="switch" id="gamesetting-toggle" :aria-checked="gameSettingEnabled.toString()"
                            @click="gameSettingEnabled = !gameSettingEnabled" {# <--- saveSetting 호출 제거 #}
                            :class="gameSettingEnabled ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-700'"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <span class="sr-only">게임셋팅하기</span>
                            <span :class="gameSettingEnabled ? 'translate-x-5' : 'translate-x-0'"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="soundsetting-toggle"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300">소리설정</label>
                        <button type="button" role="switch" id="soundsetting-toggle" :aria-checked="soundSettingEnable.toString()"
                            @click="soundSettingEnable = !soundSettingEnable" {# <--- saveSetting 호출 제거 #}
                            :class="soundSettingEnable ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-700'"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <span class="sr-only">소리설정</span>
                            <span :class="soundSettingEnable ? 'translate-x-5' : 'translate-x-0'"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="chkmoneyinfo-toggle"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300">금액정보보이기</label>
                        <button type="button" role="switch" id="chkmoneyinfo-toggle" :aria-checked="moneyInfoVisible.toString()"
                            @click="moneyInfoVisible = !moneyInfoVisible" {# <--- saveSetting 호출 제거 #}
                            :class="moneyInfoVisible ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-700'"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <span class="sr-only">금액정보보이기</span>
                            <span :class="moneyInfoVisible ? 'translate-x-5' : 'translate-x-0'"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>

                    <div class="flex items-center justify-between">
                        <label for="chkconsole-toggle"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300">콘솔박스보이기</label>
                        <button type="button" role="switch" id="chkconsole-toggle" :aria-checked="showConsoleEnable.toString()"
                            @click="showConsoleEnable = !showConsoleEnable" {# <--- saveSetting 호출 제거 #}
                            :class="showConsoleEnable ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-700'"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <span class="sr-only">콘솔박스보이기</span>
                            <span :class="showConsoleEnable ? 'translate-x-5' : 'translate-x-0'"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>

                    <!-- 가상배팅 활성화 스위치 -->
                    <div class="flex items-center justify-between">
                        <label for="chkvirtualbet-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300">가상배팅
                            활성화</label>
                        <button type="button" role="switch" id="chkvirtualbet-toggle" :aria-checked="virtualBettingEnabled.toString()"
                            @click="virtualBettingEnabled = !virtualBettingEnabled" {# <--- saveSetting 호출 제거 #}
                            :class="virtualBettingEnabled ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-700'"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                            <span class="sr-only">가상배팅 활성화</span>
                            <span :class="virtualBettingEnabled ? 'translate-x-5' : 'translate-x-0'"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>
                </div>
            </form>
            <div class="mt-6 flex justify-end gap-2">
                <button @click="open=false"
                        class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
                    닫기
                </button>
                <button @click="saveSettings(); open=false" {# <--- saveSettings에 인자 전달 제거 #}
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 마이페이지 모달 -->
<div id="mypage-content-modal"
     x-data="{ open: false }"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-[99999] flex items-center justify-center bg-black bg-opacity-50"
     @keydown.escape.window="open = false"
     @modal-open.window="
        console.log('mypage-content-modal: modal-open 이벤트 수신', $el.id, $event.detail.modalId);
        if ($event.detail.modalId === $el.id) { 
            open = true;
            console.log('mypage-content-modal: open 상태 true로 변경됨');
        }
     "
     @modal-close.window="if ($event.detail.modalId === $el.id) open = false">

  <div x-show="open"
       x-transition:enter="ease-out duration-300"
       x-transition:enter-start="opacity-0 translate-y-4 scale-95"
       x-transition:enter-end="opacity-100 translate-y-0 scale-100"
       x-transition:leave="ease-in duration-200"
       x-transition:leave-start="opacity-100 translate-y-0 scale-100"
       x-transition:leave-end="opacity-0 translate-y-4 scale-95"
       class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg w-[90%] max-w-3xl max-h-[90vh] p-6 flex flex-col">

    <!-- 헤더 -->
    <div class="flex items-center justify-between border-b pb-3 dark:border-gray-600">
      <h3 id="mypage-modal-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100">마이페이지</h3>
      <button type="button" @click="open = false" class="rounded-full p-1.5 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600" aria-label="닫기">
        <i class="ti ti-x text-xl"></i>
      </button>
    </div>

    <!-- 바디 -->
    <div id="mypage-modal-body-content" class="flex-1 overflow-y-auto p-6">
      <div id="mypage-modal-loading"
           class="flex h-40 items-center justify-center text-gray-500 dark:text-gray-400">
        <i class="ti ti-loader animate-spin text-3xl"></i>
        <span class="ml-2">로딩 중...</span>
      </div>
    </div>

    <!-- 푸터 -->
    <div class="flex justify-end border-t pt-4 dark:border-gray-600">
      <button type="button" @click="open = false" class="bg-gray-200 px-5 py-2 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-100">
        닫기
      </button>
    </div>
  </div>
</div>


<!-- 설정된 금액표 모달 -->
<div id="won-modal"
    x-data="{ open: false }"
    x-show="open"
    x-cloak
    class="fixed inset-0 z-[99999] flex items-center justify-center bg-black bg-opacity-50"
    role="dialog" aria-modal="true" aria-labelledby="moneystepinfo-title"
    @keydown.escape.window="open = false"
    @modal-open.window="if ($event.detail && $event.detail.modalId === $el.id) open = true"
    @modal-close.window="if ($event.detail && $event.detail.modalId === $el.id) open = false"
    >
    
    <div x-show="open"
         x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg w-[90%] max-w-md p-6 flex flex-col"
         @click.stop
         x-init="$watch('open', value => {
            if (value) {
                showMoneyInfoPop($el, moneyArrStep);
            } else {
                const modalBody = $el.querySelector('#won-modal-body');
                if (modalBody) modalBody.innerHTML = '';
            }
        });">

        <!-- 헤더 -->
        <div class="flex items-center justify-between border-b pb-3 dark:border-gray-600">
            <h3 class="text-lg font-semibold leading-6 text-gray-900 dark:text-gray-100">
                금액 정보
            </h3>
            <button type="button" @click="open = false"
                class="rounded-md p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:hover:bg-gray-700">
                <span class="sr-only">닫기</span>
                <i class="ti ti-x text-xl"></i>
            </button>
        </div>
        <!-- 바디 -->
        <div id="won-modal-body" class="mt-4 flex flex-wrap gap-2 sm:gap-3 justify-center">
        </div>
        <!-- 푸터 -->
        <div class="mt-5 flex justify-end border-t pt-4 dark:border-gray-600">
            <button type="button" @click="open = false"
                class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                확인
            </button>
        </div>
    </div>
</div>

<!-- alert-modal 블록 -->
<div id="alert-modal"
    x-data="{ open: false, title: '', message: '', icon: '', onConfirm: () => {} }"
    x-show="open"
    x-cloak
    class="fixed inset-0 z-[99999] flex items-center justify-center bg-black bg-opacity-50"
    role="dialog" aria-modal="true" aria-labelledby="alert-modal-title"
    @keydown.escape.window="open = false"
    @modal-open.window="if ($event.detail && $event.detail.modalId === $el.id) open = true"
    @modal-close.window="if ($event.detail && $event.detail.modalId === $el.id) open = false"
    @show-custom-alert.window="
        console.log('alert-modal: show-custom-alert 이벤트 수신', $event.detail);
        title = $event.detail.title;
        message = $event.detail.message;
        icon = $event.detail.icon;
        onConfirm = $event.detail.onConfirm;
        open = true;
    "
    >
    
    <div x-show="open"
         x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg w-[90%] max-w-sm p-6 flex flex-col"
         @click.stop
         x-init="$watch('open', value => {
            if (value) {
                // 모달이 열릴 때 추가적인 초기화는 필요 없음 (데이터는 이미 이벤트로 설정됨)
            } else {
                // 닫힐 때 내부 콘텐츠 초기화 없음
            }
        });">
        <!-- 헤더 -->
        <div
            class="flex flex-shrink-0 items-center justify-between rounded-t-2xl border-b border-gray-200 bg-gray-50 px-6 py-4 dark:border-gray-700 dark:bg-gray-700/50">
            <h3 id="alert-modal-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100" x-text="title">
                알림
            </h3>
        </div>
        <!-- 바디 -->
        <div class="flex-1 p-6">
            <!-- 아이콘 -->
            <div id="alert-modal-icon-wrapper"
                :class="{
                    'bg-green-100 dark:bg-green-900/50': icon === 'success',
                    'bg-red-100 dark:bg-red-900/50': icon === 'error',
                    'bg-yellow-100 dark:bg-yellow-900/50': icon === 'warning',
                    'bg-blue-100 dark:bg-blue-900/50': icon === 'info' || icon === ''
                }"
                class="mx-auto flex h-12 w-12 items-center justify-center rounded-full mb-4">
                <template x-if="icon === 'success'"><i class="ti ti-check text-2xl text-green-600 dark:text-green-400"></i></template>
                <template x-if="icon === 'error'"><i class="ti ti-x text-2xl text-red-600 dark:text-red-400"></i></template>
                <template x-if="icon === 'warning'"><i class="ti ti-alert-triangle text-2xl text-yellow-600 dark:text-yellow-400"></i></template>
                <template x-if="icon === 'info' || icon === ''"><i class="ti ti-info-circle text-2xl text-blue-600 dark:text-blue-400"></i></template>
            </div>
            <!-- 메시지 -->
            <p id="alert-modal-message" class="text-sm text-gray-600 dark:text-gray-400" x-text="message">
            </p>
        </div>
        <!-- 푸터 -->
        <div
            class="flex flex-shrink-0 items-center justify-center rounded-b-2xl border-t border-gray-200 bg-gray-50 px-6 py-4 dark:border-gray-700 dark:bg-gray-700/50">
            <button id="alert-modal-confirm-btn" type="button" @click="open = false; onConfirm()"
                class="w-full rounded-lg bg-blue-600 px-5 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition duration-150">
                확인
            </button>
        </div>
    </div>
</div>
